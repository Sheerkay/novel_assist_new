# ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿé‡æ„è¯´æ˜

## é‡æ„ç›®æ ‡

æ¶ˆé™¤æç¤ºè¯æ¨¡æ¿å’ŒæœåŠ¡å‡½æ•°ä¸­é‡å¤çš„ä¸Šä¸‹æ–‡å¤„ç†ä»£ç ï¼Œå»ºç«‹ç»Ÿä¸€çš„ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿã€‚

## é‡æ„å†…å®¹

### 1. æ–°å¢æ¨¡å—ï¼š`context_manager.py`

åˆ›å»ºäº† `ContextManager` ç±»ï¼Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç±»å‹çš„ä¸Šä¸‹æ–‡ï¼š

```python
class ContextManager:
    def set_additional_context(context_string, context_chapters)
    def get_context_for_intent(intent)  # æ ¹æ®æ„å›¾è¿”å›ç›¸åº”ä¸Šä¸‹æ–‡
    def build_messages(intent, user_prompt, system_prompt_name, template_name)
    def _format_chapter_list()  # æ ¼å¼åŒ–ç« èŠ‚åˆ—è¡¨
    def clear()  # æ¸…ç©ºä¸Šä¸‹æ–‡
```

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- é›†ä¸­ç®¡ç†é™„åŠ ä¸Šä¸‹æ–‡ï¼ˆç« èŠ‚å†…å®¹ã€å‰§æƒ…åº“ç­‰ï¼‰
- æ ¹æ®ä¸åŒæ„å›¾ï¼ˆchat, plot_design, novel_generationï¼‰è¿”å›åˆé€‚çš„ä¸Šä¸‹æ–‡
- è‡ªåŠ¨æ ¼å¼åŒ–ç« èŠ‚åˆ—è¡¨
- æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆåŒ…å«ç³»ç»Ÿæç¤ºè¯å’Œç”¨æˆ·æç¤ºè¯ï¼‰

### 2. æ›´æ–° `ai_service.py`

**æ–°å¢å‡½æ•°ï¼š**
```python
def generate_content_with_intent(intent, user_prompt, context_manager)
```

è¿™æ˜¯æ–°çš„ç»Ÿä¸€å…¥å£ç‚¹ï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¥ï¼š
- æ ¹æ®æ„å›¾é€‰æ‹©åˆé€‚çš„æ¨¡æ¿å’Œç³»ç»Ÿæç¤ºè¯
- è‡ªåŠ¨å¤„ç†ä¸Šä¸‹æ–‡æ ¼å¼åŒ–
- è°ƒç”¨ DeepSeek API ç”Ÿæˆå†…å®¹

**ä¿ç•™çš„æ—§å‡½æ•°ï¼ˆå‘åå…¼å®¹ï¼‰ï¼š**
- `generate_novel_content()`
- `generate_plot_design()`
- `generate_full_novel()`
- `_generate_content_with_template()`

### 3. æ›´æ–° `generation_routes.py`

ä¿®æ”¹ `/api/generate-with-analysis` è·¯ç”±ï¼š

```python
# åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨å¹¶è®¾ç½®ä¸Šä¸‹æ–‡
context_manager = ContextManager()
context_manager.set_additional_context(context_string, [])

# ä½¿ç”¨æ–°çš„ç»Ÿä¸€æ¥å£
content = ai_service.generate_content_with_intent(intent, prompt, context_manager)
```

**æ”¹è¿›ï¼š**
- ç®€åŒ–äº†è·¯ç”±é€»è¾‘ï¼Œä¸å†éœ€è¦æ ¹æ®æ„å›¾åˆ†åˆ«è°ƒç”¨ä¸åŒå‡½æ•°
- ä¸Šä¸‹æ–‡ç®¡ç†é›†ä¸­åŒ–ï¼Œä»£ç æ›´æ¸…æ™°

## æ¶æ„æ”¹è¿›

### ä¹‹å‰çš„é—®é¢˜ï¼š
1. âŒ ä¸Šä¸‹æ–‡æ ¼å¼åŒ–ä»£ç æ•£è½åœ¨å¤šä¸ªåœ°æ–¹ï¼ˆ`_generate_content_with_template`ã€å„ä¸ªæ¨¡æ¿ï¼‰
2. âŒ æ¯ä¸ªç”Ÿæˆå‡½æ•°éƒ½éœ€è¦å¤„ç† `context` å’Œ `context_chapters` å‚æ•°
3. âŒ æ¨¡æ¿ä¸­é‡å¤ç¼–å†™ç›¸åŒçš„ä¸Šä¸‹æ–‡å¤„ç†é€»è¾‘
4. âŒ éš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•

### ç°åœ¨çš„ä¼˜åŠ¿ï¼š
1. âœ… ç»Ÿä¸€çš„ä¸Šä¸‹æ–‡ç®¡ç†å…¥å£ï¼ˆContextManagerï¼‰
2. âœ… è‡ªåŠ¨æ ¹æ®æ„å›¾æä¾›åˆé€‚çš„ä¸Šä¸‹æ–‡
3. âœ… æ¶ˆé™¤äº†é‡å¤ä»£ç 
4. âœ… æ˜“äºæ‰©å±•ï¼ˆå¦‚æ·»åŠ å¯¹è¯å†å²åŠŸèƒ½ï¼‰
5. âœ… èŒè´£åˆ†ç¦»æ¸…æ™°ï¼š
   - `ContextManager`ï¼šç®¡ç†ä¸Šä¸‹æ–‡
   - `ai_service`ï¼šè°ƒç”¨ AI API
   - `generation_routes`ï¼šå¤„ç† HTTP è¯·æ±‚

## æ„å›¾ä¸ä¸Šä¸‹æ–‡å¯¹åº”å…³ç³»

| æ„å›¾ç±»å‹ | æ˜¯å¦ä½¿ç”¨é™„åŠ ä¸Šä¸‹æ–‡ | æ¸©åº¦å‚æ•° | æ¨¡æ¿ |
|---------|------------------|---------|------|
| `chat` | âŒ ä¸ä½¿ç”¨ | 0.7 | æ—  |
| `plot_design` | âœ… ä½¿ç”¨ | 0.5 | plot_design.txt |
| `novel_generation` | âœ… ä½¿ç”¨ | 0.7 | novel_generation.txt |

## å‘åå…¼å®¹æ€§

æ—§çš„å‡½æ•°æ¥å£ä»ç„¶ä¿ç•™ï¼Œç¡®ä¿ä¸ä¼šç ´åç°æœ‰ä»£ç ï¼š
- `generate_novel_content(prompt, context, context_chapters)`
- `generate_plot_design(prompt, context, context_chapters)`
- `generate_full_novel(prompt, context, context_chapters)`

ä½†æ¨èä½¿ç”¨æ–°æ¥å£ï¼š
- `generate_content_with_intent(intent, user_prompt, context_manager)`

## æœªæ¥æ‰©å±•

ContextManager è®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œé¢„ç•™äº†ä»¥ä¸‹æ‰©å±•ç‚¹ï¼š

1. **å¯¹è¯å†å²ç®¡ç†**
   ```python
   self.conversation_history = []  # å·²é¢„ç•™å­—æ®µ
   ```

2. **æ›´å¤šä¸Šä¸‹æ–‡ç±»å‹**
   - äººç‰©è®¾å®šåº“
   - ä¸–ç•Œè§‚è®¾å®š
   - é£æ ¼æŒ‡å—

3. **ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§**
   æ ¹æ®ä¸åŒæ„å›¾è‡ªåŠ¨è°ƒæ•´ä¸Šä¸‹æ–‡çš„æƒé‡å’Œé¡ºåº

## æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯é‡æ„ï¼š
```bash
python backend/test_context_manager.py
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… ä¸Šä¸‹æ–‡è®¾ç½®å’Œè·å–
- âœ… ä¸åŒæ„å›¾çš„ä¸Šä¸‹æ–‡è¿”å›
- âœ… ç« èŠ‚åˆ—è¡¨æ ¼å¼åŒ–

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼š
- `backend/app/services/context_manager.py` - ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- `backend/test_context_manager.py` - æµ‹è¯•è„šæœ¬
- `backend/ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿé‡æ„è¯´æ˜.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶ï¼š
- `backend/app/services/ai_service.py` - æ–°å¢ `generate_content_with_intent()` å‡½æ•°
- `backend/app/api/generation_routes.py` - ä½¿ç”¨ ContextManager

### æœªä¿®æ”¹ï¼ˆä½†å°†æ¥å¯ä¼˜åŒ–ï¼‰ï¼š
- æç¤ºè¯æ¨¡æ¿æ–‡ä»¶ï¼ˆ`plot_design.txt` ç­‰ï¼‰ä»ç„¶åŒ…å« `{context}` å ä½ç¬¦ï¼Œè¿™æ˜¯æ­£å¸¸çš„
- æ¨¡æ¿è´Ÿè´£å®šä¹‰"å¦‚ä½•å±•ç¤ºä¸Šä¸‹æ–‡"ï¼ŒContextManager è´Ÿè´£"æä¾›ä»€ä¹ˆä¸Šä¸‹æ–‡"

## æ€»ç»“

è¿™æ¬¡é‡æ„å®ç°äº†ï¼š
1. ğŸ¯ **ä»£ç æ•´æ´**ï¼šæ¶ˆé™¤äº†é‡å¤çš„ä¸Šä¸‹æ–‡å¤„ç†é€»è¾‘
2. ğŸ”§ **æ˜“äºç»´æŠ¤**ï¼šä¸Šä¸‹æ–‡ç®¡ç†é›†ä¸­åœ¨ä¸€ä¸ªç±»ä¸­
3. ğŸš€ **æ˜“äºæ‰©å±•**ï¼šä¸ºæœªæ¥åŠŸèƒ½ï¼ˆå¦‚å¯¹è¯å†å²ï¼‰é¢„ç•™äº†æ¥å£
4. âœ… **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½
5. ğŸ“¦ **èŒè´£æ¸…æ™°**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£æ˜ç¡®ï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
