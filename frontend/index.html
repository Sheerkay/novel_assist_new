<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI写网文助手 - V17.0 上下文选择重构</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <header>
             <div class="header-content">
                <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="切换导航"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg></button>
                <div class="logo">AI写网文助手</div>
            </div>
        </header>

        <div class="page-body sidebar-collapsed" id="pageBody">
            <nav class="app-sidebar">
                 <ul class="sidebar-menu">
                    <li class="sidebar-menu-item active" data-mode="edit"><a href="#"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04c.39-.39.39-1.02,0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41,0l-1.83,1.83,3.75,3.75,1.83-1.83M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25Z"/></svg><span>编辑续写</span></a></li>
                    <li class="sidebar-menu-item" data-mode="create"><a href="#"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.56,4.44,19.56,2.44a1.5,1.5,0,0,0-2.12,0L4.58,15.29a1,1,0,0,0-.29.71L4,21a1,1,0,0,0,1,1l5-.29a1,1,0,0,0,.71-.29L21.56,6.56A1.5,1.5,0,0,0,21.56,4.44ZM9.1,18.05l-3.6.21L5.7,14.65l8-8L17.3,10.25Zm8.1-8.1-1.4,1.4-3.6-3.6,1.4-1.4a.5.5,0,0,1,.71,0l2.89,2.89A.5.5,0,0,1,17.2,9.95Z"/></svg><span>创作小说</span></a></li>
                </ul>
            </nav>

            <main class="main-content">
                
                <div class="main-tabs-container">
                     <div class="main-tabs">
                        <button class="tab-btn active" data-tab="plot-design">剧情设计</button>
                        <button class="tab-btn" data-tab="generate-text">生成原文</button>
                    </div>
                </div>

                <div class="workspace">
                    <div id="plot-design-view" class="tab-content">
                        <div id="context-selection-area">
                            <h3 class="context-area-title">附加上下文</h3>
                            <div class="context-categories-wrapper">
                                <details class="context-category" id="context-chapters-category" open>
                                    <summary>
                                        <input type="checkbox" id="master-checkbox-chapters" class="master-checkbox" title="勾选以启用所有已选原文章节作为上下文" checked>
                                        📚 原文章节
                                        <span class="item-count" id="chapters-preview-count">0 项</span>
                                    </summary>
                                    <ul class="context-preview-list" id="chapters-preview-list">
                                        <li class="placeholder">请通过右侧“加载小说”按钮选择章节。</li>
                                    </ul>
                                </details>
                                <details class="context-category" id="context-summaries-category" open>
                                    <summary>
                                        <input type="checkbox" id="master-checkbox-summaries" class="master-checkbox" title="勾选以启用所有已选剧情梗概作为上下文" checked>
                                        💡 剧情梗概
                                        <span class="item-count" id="summaries-preview-count">0 项</span>
                                    </summary>
                                    <ul class="context-preview-list" id="summaries-preview-list">
                                        <li class="placeholder">请通过“剧情库”选择或“存为剧情”添加梗概。</li>
                                    </ul>
                                </details>
                            </div>
                        </div>

                        <div class="conversation-history" id="conversationHistory">
                            <div class="bubble ai-bubble"><p>你好！请点击右侧“加载小说”按钮加载您的小说，然后在上方区域选择所需的上下文，就可以开始创作了！</p></div>
                        </div>
                    </div>

                    <div id="generate-text-view" class="tab-content hidden">
                        <div class="placeholder-page">
                            <h2>生成原文</h2>
                            <p>此功能区域用于将来整合、编辑和导出最终生成的完整小说内容。</p>
                        </div>
                    </div>
                </div>

                <div class="prompt-wrapper">
                     <div class="prompt-area">
                        <div id="selected-context-viewer" style="margin-bottom: 10px; font-size: 0.9rem; color: #555;">
                            <strong style="cursor: pointer;" id="selected-context-toggle">附加上下文详情 (0 项)</strong>
                            <div id="selected-context-details" class="hidden" style="max-height: 150px; overflow-y: auto; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; margin-top: 5px; line-height: 1.6;">
                                <!-- Details will be populated by JS -->
                            </div>
                        </div>
                        <textarea id="promptInput" placeholder="在此输入你的提示词... (Ctrl+Enter 快捷发送)"></textarea>
                        <div class="prompt-footer">
                            <div class="model-selector">
                                <label for="modelSelect">使用模型:</label>
                                <select id="modelSelect">
                                    <option value="deepseek3.1">DeepSeek V3.1</option>
                                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                </select>
                            </div>
                            <button class="btn" id="sendPromptBtn">发送</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="selectSourceModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>加载小说原文</h2>
                <span class="close-btn">&times;</span>
            </div>
            <!-- index.html: 找到 id="selectSourceModal" 并修改 modal-body 和 modal-footer -->

            <div class="modal-body">
                <!-- 视图1: 上传文件 -->
                <div id="uploadView">
                    <div id="uploadArea">
                        <p>点击或拖拽TXT文件到此处</p>
                        <p id="fileNameDisplay"></p>
                        <input type="file" id="fileInput" accept=".txt" style="display:none;">
                    </div>
                    <button class="btn" id="uploadAndParseBtn" style="width: 100%; margin-top: 15px;" disabled>上传并解析</button>
                </div>
                <!-- 视图2: 选择章节 -->
                <div id="chapterSelectionView" style="display: none;">
                    <p style="margin-bottom: 10px;">已加载小说：<strong id="loadedFileName"></strong></p>
                    <p style="margin-bottom: 15px; font-size: 0.9em; color: #555;">请勾选需要作为上下文的章节：</p>
                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                        <button class="btn btn-secondary btn-sm" id="selectAllChaptersButton">全选</button> 
                    </div>
                    <div id="chapterListForSelection" style="max-height: 40vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                        <!-- 章节列表将由JS动态生成 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="sourceModalFooter">
                <button class="btn btn-secondary" id="changeNovelBtn" style="display: none; margin-right: auto;">更换小说</button>
                <button class="btn btn-secondary" id="cancelSourceSelectBtn">关闭</button>
                <button class="btn" id="confirmChapterSelectionBtn" style="display: none;">确认选择</button>
            </div>
            
        </div>
    </div>
    <div id="viewDraftsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>我的定稿</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body modal-grid">
                <div class="list-panel">
                    <ul id="draftsListContainer" class="list-container"></ul>
                    <div class="list-actions"><button class="btn btn-secondary">合并下载</button></div>
                </div>
                <div id="draftsPreviewArea" class="preview-area">
                    <h3>请从左侧选择章节以预览</h3>
                    <p style="color: #666;">...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeDraftsModalBtn">关闭</button>
            </div>
        </div>
    </div>
    <div id="plotContextModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>已存剧情概览</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body modal-grid">
                <div class="list-panel">
                    <div style="padding: 10px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center;">
                        <button class="btn btn-secondary btn-sm" id="selectAllPlotsButton">全选</button> 
                    </div>
                    <ul id="plotListContainer" class="list-container"></ul>
                </div>
                <div id="plotPreviewArea" class="preview-area">
                    <h3>请从左侧选择剧情以预览</h3>
                    <p style="color: #666;">您可以在此查看所有已保存的剧情梗概。具体的上下文选择请在主界面的勾选框中进行。</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closePlotContextModalBtn">关闭</button>
                <button class="btn btn-success" id="addSelectedPlotsBtn">添加至梗概</button>
            </div>
        </div>
    </div>

    <div class="floating-action-bar">
        <button class="fab-btn" id="fabSelectContextBtn" title="加载小说原文">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13.5,16V19H10.5V16H8L12,12L16,16H13.5M13,9V3.5L18.5,9H13Z" /></svg>
            <span>加载小说</span>
        </button>
        <button class="fab-btn" id="fabPlotContextBtn" title="查看剧情库">
            <svg class="plot-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A7,7 0 0,0 5,9C5,11.38 6.19,13.47 8,14.74V17A1,1 0 0,0 9,18H15A1,1 0 0,0 16,17V14.74C17.81,13.47 19,11.38 19,9A7,7 0 0,0 12,2M9,21A1,1 0 0,0 10,22H14A1,1 0 0,0 15,21V20H9V21Z" /></svg>
            <span>剧情库(<span id="plotContextCount">0</span>)</span>
        </button>
        <button class="fab-btn" id="fabViewDraftsBtn" title="查看我的定稿">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17,3H7A2,2 0 0,0 5,5V21L12,18L19,21V5C19,3.89 18.1,3 17,3M15,9H9V11H15V9Z" /></svg>
            <span>定稿(<span id="draftsCount">0</span>)</span>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="js/main.js"></script>
</body>
</html>