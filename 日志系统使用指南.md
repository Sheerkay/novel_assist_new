# 日志系统使用指南

## 概述

本项目实现了前后端统一的日志管理系统，将所有调试信息集中管理，便于开发和问题排查。

## 后端日志系统

### 文件位置
- **日志模块**: `backend/app/utils/logger.py`
- **日志文件**: `backend/logs/` 目录
  - `api.log` - API请求和响应日志
  - `ai_service.log` - AI服务调用日志
  - `novel_service.log` - 小说服务日志
  - `app.log` - 应用程序日志

### 使用方法

```python
from app.utils.logger import api_logger, ai_logger, log_request, log_response

# 记录API请求
log_request('/api/summarize-chapters', {'chapter_count': 2})

# 记录API响应
log_response('/api/summarize-chapters', 200, {'summary_length': 500})

# 使用logger直接记录
api_logger.info('处理章节概括请求')
api_logger.error('处理失败', exc_info=True)

# AI服务日志
ai_logger.info('调用DeepSeek API')
```

### 日志级别
- `DEBUG` - 详细调试信息
- `INFO` - 一般信息
- `WARNING` - 警告信息
- `ERROR` - 错误信息

### 日志特性
- ✅ 自动按日期时间格式化
- ✅ 同时输出到控制台和文件
- ✅ 文件自动分割（单文件最大10MB，保留5个备份）
- ✅ UTF-8编码支持中文
- ✅ 彩色控制台输出（开发环境）

## 前端日志系统

### 文件位置
- **日志模块**: `frontend/js/logger.js`

### 使用方法

```javascript
// API相关日志
Logger.api.request('/api/summarize-chapters', 'POST', data);
Logger.api.response('/api/summarize-chapters', 200, result);
Logger.api.error('/api/summarize-chapters', error);

// 章节相关日志
Logger.chapter.select(chapters);
Logger.chapter.summarize(chapters);
Logger.chapter.summaryResult(summary);

// 上下文相关日志
Logger.context.update('原文章节', 3);
Logger.context.send(contextParts);

// UI操作日志
Logger.ui.action('点击概括按钮', { chapterCount: 2 });
Logger.ui.error('加载失败', error);

// 通用日志方法
Logger.info('分类', '消息内容', 数据对象);
Logger.warn('分类', '警告信息', 数据对象);
Logger.error('分类', '错误信息', 错误对象);
Logger.debug('分类', '调试信息', 数据对象);
```

### 浏览器控制台命令

打开浏览器开发者工具（F12），在Console中可以使用：

```javascript
// 查看所有日志历史
Logger.getHistory();

// 查看特定类别的日志
Logger.getHistory({ category: 'API' });
Logger.getHistory({ level: 'ERROR' });

// 导出日志到文件
Logger.export();

// 清空日志
Logger.clearHistory();

// 设置日志级别（0=DEBUG, 1=INFO, 2=WARN, 3=ERROR）
Logger.currentLevel = 1;  // 只显示INFO及以上级别
```

### 日志特性
- ✅ 彩色分类标签
- ✅ 时间戳（精确到毫秒）
- ✅ 日志历史记录（最多100条）
- ✅ 一键导出日志文件
- ✅ 灵活的日志级别控制
- ✅ 开发模式自动启用

## 日志查看

### 后端日志查看

**1. 实时查看（终端）**
```powershell
# 运行后端时自动显示
cd backend
python run.py
```

**2. 查看历史日志文件**
```powershell
# 查看最新的API日志
Get-Content backend/logs/api.log -Tail 50

# 查看AI服务日志
Get-Content backend/logs/ai_service.log -Tail 50

# 实时监控日志（PowerShell）
Get-Content backend/logs/api.log -Wait
```

**3. 使用文本编辑器**
- 直接打开 `backend/logs/` 目录中的日志文件
- 推荐使用VS Code打开，支持搜索和高亮

### 前端日志查看

**1. 浏览器开发者工具**
- 按 `F12` 打开开发者工具
- 切换到 `Console` 标签
- 查看格式化的彩色日志

**2. 导出日志**
```javascript
// 在浏览器控制台执行
Logger.export();
```
会自动下载包含所有日志的文本文件。

## 日志分类说明

### 后端日志分类
- **api** - API路由层的请求和响应
- **ai_service** - AI服务调用（DeepSeek API）
- **novel_service** - 小说相关业务逻辑
- **app** - 应用程序级别的日志

### 前端日志分类
- **API** - 前端API调用
- **章节** - 章节选择和处理
- **上下文** - 上下文管理
- **UI** - 用户界面操作

## 开发建议

### 何时使用日志

✅ **应该记录：**
- API请求和响应
- 重要的业务逻辑执行
- AI调用的提示词和结果
- 用户关键操作
- 错误和异常

❌ **不应该记录：**
- 过于频繁的循环内部
- 敏感信息（密码、密钥等）
- 超大数据对象（会导致日志文件过大）

### 日志级别选择

```
DEBUG   - 详细的调试信息，仅在开发时使用
INFO    - 一般的业务流程信息
WARNING - 潜在问题，但不影响运行
ERROR   - 错误信息，需要关注和修复
```

### 性能考虑

- 生产环境建议设置日志级别为 `INFO` 或 `WARNING`
- 避免在循环中记录大量日志
- 定期清理旧的日志文件

## 故障排查

### 问题：后端日志文件没有生成

**解决方案：**
1. 检查 `backend/logs/` 目录是否存在（首次运行会自动创建）
2. 检查文件写入权限
3. 查看终端是否有错误信息

### 问题：前端日志不显示

**解决方案：**
1. 确认已引入 `logger.js`：检查 `index.html` 中的 `<script>` 标签
2. 检查浏览器控制台是否有加载错误
3. 确认 `Logger.currentLevel` 设置是否正确

### 问题：日志文件过大

**解决方案：**
- 后端日志会自动分割（10MB/文件，保留5个备份）
- 可以手动删除旧的日志文件
- 调整日志级别，减少不必要的日志输出

## 扩展功能

未来可以添加：
- [ ] 前端UI日志查看面板
- [ ] 日志远程上传和分析
- [ ] 日志搜索和过滤界面
- [ ] 实时日志推送（WebSocket）
- [ ] 日志统计和图表

## 总结

使用统一的日志系统的优势：
- ✅ 代码更整洁（日志逻辑与业务逻辑分离）
- ✅ 易于管理和查看
- ✅ 统一的格式和风格
- ✅ 灵活的级别控制
- ✅ 便于问题排查和性能分析
